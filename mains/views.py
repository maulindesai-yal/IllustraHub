from django.shortcuts import render,redirect,get_object_or_404
from django.contrib import messages
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_POST
from django.db.models import Min, Count
from mains.models import Illustration ,Category, CartItem,Bid
from authenticate.models import CustomUser
from django.db.models import Count, F, Q, Max
from authenticate.country_choices import COUNTRY_CHOICES
from django.utils import timezone
from django.http import JsonResponse,HttpResponse
from asgiref.sync import async_to_sync
from channels.layers import get_channel_layer
from django.urls import reverse
import json
#from .category import Categories
# Create your views here.

def collection_view(request):
    # Get all categories with their first (most recent) illustration
    categories = Category.objects.all()
    category_illustrations = []
    
    for category in categories:
        # Get the first uploaded illustration in this category
        first_illustration = Illustration.objects.filter(
            category=category
        ).order_by('-uploaded_at').first()
        
        if first_illustration:
            category_illustrations.append({
                'category': category,
                'illustration': first_illustration
            })
    
    return render(request, 'main_templates/collection.html', {
        'category_illustrations': category_illustrations
    })

def category_collection_view(request, category_id):
    category = get_object_or_404(Category, id=category_id)

    # Get illustrators who have uploaded illustrations in this category
    illustrators = CustomUser.objects.filter(
        user_type='illustrator',
        mains_illustrations__category=category
    ).distinct()

    # Create a list of illustrators with their first uploaded illustration in this category
    illustrators_with_illustrations = []
    for illustrator in illustrators:
        first_illustration = Illustration.objects.filter(
            uploaded_by=illustrator,
            category=category
        ).order_by('uploaded_at').first()  # Get the first uploaded illustration

        if first_illustration:
            illustrators_with_illustrations.append({
                'illustrator': illustrator,
                'illustration': first_illustration
            })

    return render(request, 'main_templates/category_collection.html', {
        'category': category,
        'illustrators_with_illustrations': illustrators_with_illustrations
    })

def illustrator_category_collection_view(request, category_id, illustrator_email):
    category = get_object_or_404(Category, id=category_id)
    illustrator = get_object_or_404(CustomUser, email=illustrator_email)
    
    # Get all illustrations by this illustrator in this category
    illustrations = Illustration.objects.filter(
        category=category,
        uploaded_by=illustrator
    ).order_by('-uploaded_at')
    
    return render(request, 'main_templates/illustrator_category_collection.html', {
        'category': category,
        'illustrator': illustrator,
        'illustrations': illustrations
    })

@login_required
def my_artworks_view(request):
    if request.user.user_type != 'illustrator':
        messages.error(request, 'You do not have permission to upload illustrations.')
        return redirect('home')
    
    categories = Category.objects.all() #fetching category from database
    user_artworks = Illustration.objects.filter(uploaded_by=request.user).order_by('-uploaded_at')

    if request.method == 'POST':
        title = request.POST.get('title')
        description = request.POST.get('description')
        category_id = request.POST.get('category')
        price = request.POST.get('price')
        image = request.FILES.get('image')
        selling_type = request.POST.get('selling_type')

        # Validate required fields
        if not all([title, description, category_id, image, selling_type]):
            messages.error(request, 'Please fill in all required fields.')
            return render(request, 'main_templates/my_artworks.html', {
                'categories': categories,
                'user_artworks': user_artworks
            })        
        try:
            category = get_object_or_404(Category, id=category_id)
            
            Illustration.objects.create(
                title=title,
                description=description,
                category=category,
                price=price if price else None,
                image=image,
                uploaded_by=request.user,
                selling_type=selling_type 
            )
            
            messages.success(request, 'Illustration uploaded successfully!')
            return redirect('my_artworks')
        
        except Exception as e:
            messages.error(request, f'Error uploading illustration: {str(e)}')
    
    return render(request, 'main_templates/my_artworks.html',{
        'categories': categories,
        'user_artworks': user_artworks
    })

@login_required
def edit_artwork(request, artwork_id):
    artwork = get_object_or_404(Illustration, id=artwork_id, uploaded_by=request.user)
    categories = Category.objects.all()

    if request.method == 'POST':
        title = request.POST.get('title')
        description = request.POST.get('description')
        category_id = request.POST.get('category')
        price = request.POST.get('price')
        selling_type = request.POST.get('selling_type')
        image = request.FILES.get('image')

        try:
            category = get_object_or_404(Category, id=category_id)
            
            artwork.title = title
            artwork.description = description
            artwork.category = category
            artwork.price = price if price else None
            artwork.selling_type = selling_type
            
            if image:
                artwork.image = image
            
            artwork.save()
            messages.success(request, 'Artwork updated successfully!')
            return redirect('my_artworks')
            
        except Exception as e:
            messages.error(request, f'Error updating artwork: {str(e)}')

    return render(request, 'main_templates/edit_artwork.html', {
        'artwork': artwork,
        'categories': categories
    })

def illustrators_view(request):
    illustrators = CustomUser.objects.filter(
        user_type='illustrator'
    ).annotate(
        illustration_count=Count('mains_illustrations')
    ).filter(
        illustration_count__gt=0  # Only get illustrators with at least one illustration
    )

    sort_by = request.GET.get('sort', 'name_asc')
    if sort_by == 'name_asc':
        illustrators = illustrators.order_by('first_name','last_name')
    elif sort_by == 'name_desc':
        illustrators = illustrators.order_by('-first_name','-last_name')
    elif sort_by == 'newest':
        illustrators = illustrators.order_by('-date_joined')
    elif sort_by == 'most_illustrations':
        illustrators = illustrators.order_by('-illustration_count')

    country = request.GET.get('country')
    if country:
        illustrators = illustrators.filter(country=country)

    context = {
        'illustrators': illustrators,
        'country_choices': COUNTRY_CHOICES,
        'current_sort': sort_by,
        'current_country': country
    }
    return render(request ,'main_templates/illustrators.html', context)

@login_required
def illustration_store_view(request):
    illustrations = Illustration.objects.select_related('category')
    
    # Get filter parameters
    category_id = request.GET.get('category')
    price_range = request.GET.get('price_range')
    sort_by = request.GET.get('sort_by')
    selling_type = request.GET.get('selling_type')
    
    # Apply category filter
    if category_id:
        illustrations = illustrations.filter(category_id=category_id)
    
    # Apply price range filter
    if price_range:
        if price_range == '0-50':
            illustrations = illustrations.filter(price__lte=50)
        elif price_range == '50-100':
            illustrations = illustrations.filter(price__gt=50, price__lte=100)
        elif price_range == '100-200':
            illustrations = illustrations.filter(price__gt=100, price__lte=200)
        elif price_range == '200+':
            illustrations = illustrations.filter(price__gt=200)
    
    # Apply selling type filter
    if selling_type:
        illustrations = illustrations.filter(selling_type=selling_type)
    
    # Apply sorting
    if sort_by:
        if sort_by == 'newest':
            illustrations = illustrations.order_by('-uploaded_at')
        elif sort_by == 'price_low':
            illustrations = illustrations.order_by('price')
        elif sort_by == 'price_high':
            illustrations = illustrations.order_by('-price')
        elif sort_by == 'popular':
            illustrations = illustrations.annotate(bid_count=Count('bids')).order_by('-bid_count')
    
    # Get all categories for the filter dropdown
    categories = Category.objects.all()
    
    return render(request, 'main_templates/illustration_store.html', {
        'illustrations': illustrations,
        'categories': categories,
        'current_category': category_id,
        'current_price_range': price_range,
        'current_sort': sort_by,
        'current_selling_type': selling_type
    })


def illustrator_details_view(request, email):
    illustrator = get_object_or_404(CustomUser, email=email)
    illustrations = Illustration.objects.filter(uploaded_by=illustrator).order_by('-uploaded_at')

    return render(request, 'main_templates/illustrator_details.html', {
        'illustrator': illustrator,
        'illustrations': illustrations
    })

@login_required
def illustration_details_view(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)
    return render(request, 'main_templates/illustration_details.html',{
        'illustration': illustration
    })

def contact_us_view(request):
    if request.method == 'POST':
        name = request.POST.get('name')
        email = request.POST.get('email')
        subject = request.POST.get('subject')
        message = request.POST.get('message')
        
        # Here you would typically implement email sending logic
        # For now, just print the message (replace with actual email sending)
        print(f"Contact Form Submission:\nName: {name}\nEmail: {email}\nSubject: {subject}\nMessage: {message}") 
        messages.success(request, 'Your message has been sent successfully!')
        return redirect('contact_us')
    return render(request, 'main_templates/contact_us.html')    

def about_us_view(request):
    return render(request ,'main_templates/about_us.html')


@login_required
def place_bid(request, illustration_id):
    if request.method == 'POST':
        illustration = get_object_or_404(Illustration, id=illustration_id)
        
        # Get bid amount from either JSON or form data
        if request.content_type == 'application/json':
            data = json.loads(request.body)
            bid_amount = float(data.get('amount'))
        else:
            bid_amount = float(request.POST.get('bid_amount'))
        
        # Get current highest bid
        current_bid = Bid.objects.filter(illustration=illustration).order_by('-amount').first()
        current_bid_amount = current_bid.amount if current_bid else illustration.price
        
        # Validate bid
        if bid_amount <= current_bid_amount:
            if request.content_type == 'application/json':
                return JsonResponse({
                    'success': False,
                    'error': f"Bid amount must be higher than current bid (${current_bid_amount})."
                })
            messages.error(request, f"Bid amount must be higher than current bid (${current_bid_amount}).")
            return redirect('illustration_bidding', illustration_id=illustration_id)
        
        # Create new bid
        new_bid = Bid.objects.create(
            illustration=illustration,
            user=request.user,
            amount=bid_amount
        )
        
        # Send WebSocket message
        channel_layer = get_channel_layer()
        async_to_sync(channel_layer.group_send)(
            f'bidding_{illustration_id}',
            {
                'type': 'bid_update',
                'bid_amount': bid_amount,
                'bidder': request.user.email,
                'bidder_name': request.user.get_full_name(),
                'bidder_image': request.user.profile_image.url if hasattr(request.user, 'profile_image') else '/static/images/default-avatar.png',
                'timestamp': timezone.now().isoformat(),
                'message': 'New bid placed'
            }
        )
        
        if request.content_type == 'application/json':
            return JsonResponse({
                'success': True,
                'message': 'Bid placed successfully!'
            })
        
        messages.success(request, "Bid placed successfully!")
        return redirect('illustration_bidding', illustration_id=illustration_id)
    
    return redirect('illustration_bidding', illustration_id=illustration_id)

channel_layer = get_channel_layer()

@login_required
def start_bidding(request, illustration_id):
    """Allows illustrators to start live bidding for an illustration."""
    illustration = get_object_or_404(Illustration, id=illustration_id)
    
    # Ensure only the illustrator who uploaded the illustration can start bidding
    if request.user != illustration.uploaded_by:
        messages.error(request, "You do not have permission to start bidding for this illustration.")
        return redirect('illustration_details', illustration_id=illustration.id)
    
    if request.method == 'POST':
        # Handle the form submission
        duration = int(request.POST.get('duration', 24))
        reserve_price = request.POST.get('reserve_price')
        auto_extend = request.POST.get('auto_extend') == 'on'
        notify_bids = request.POST.get('notify_bids') == 'on'
        
        # Set the bidding end time based on duration
        illustration.bidding_end_time = timezone.now() + timedelta(hours=duration)
        illustration.is_bidding_active = True
        illustration.save()
        
        messages.success(request, "Live bidding started successfully!")
        return redirect('illustration_bidding', illustration_id=illustration.id)
    
    # For GET request, show the configuration page
    return render(request, 'main_templates/start_bidding.html', {
        'illustration': illustration
    })


@login_required
def end_bidding(request, illustration_id):
    """End bidding early for an illustration"""
    illustration = get_object_or_404(Illustration, id=illustration_id, uploaded_by=request.user)
    
    if request.method != 'POST':
        messages.error(request, "Invalid request method.")
        return redirect('illustration_details', illustration_id=illustration.id)
    
    if not illustration.is_bidding_active:
        messages.warning(request, "Bidding is not active.")
        return redirect('illustration_details', illustration_id=illustration.id)
    
    # Get the highest bid
    highest_bid = illustration.bids.order_by('-amount').first()
    
    # End the bidding
    illustration.is_bidding_active = False
    illustration.bidding_end_time = timezone.now()
    illustration.save()
    
    if highest_bid:
        messages.success(request, f"Auction ended. Highest bid: ${highest_bid.amount} by {highest_bid.user.get_full_name()}")
    else:
        messages.info(request, "Auction ended. No bids were placed.")
    
    return redirect('illustration_details', illustration_id=illustration.id)

@login_required
def mark_as_sold(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id, uploaded_by=request.user)
    highest_bid = illustration.bids.first()
    if highest_bid:
        illustration.mark_as_sold(highest_bid.user, highest_bid.amount)
        messages.success(request, f"Sold to {highest_bid.user.username} for ${highest_bid.amount}!")
    else:
        messages.warning(request, "No bids were placed.")

    return redirect('illustration_details', illustration_id=illustration.id)

@login_required
def buy_now(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)
    # Redirect to checkout (or implement direct purchase logic)
    return redirect('checkout_page', illustration_id=illustration.id)


@login_required
def checkout_page(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)


    user = request.user
    user_profile = CustomUser.objects.get(email=user.email)

    if request.method == 'POST':
        # Get user input
        name = request.POST.get('name')
        email = request.POST.get('email')
        address = request.POST.get('address')
        country = request.POST.get('country')
        state = request.POST.get('state')
        zip_code = request.POST.get('zip_code')
        payment_method = request.POST.get('payment_method')

        # Here, you would typically save the order in the database
        # Example: Order.objects.create(user=request.user, illustration=illustration, ...)

        # Redirect to a success page
        return redirect('order_success')

    return render(request, 'main_templates/checkout.html', {
        'illustration': illustration,
        'user_profile': user_profile
    })

def order_success(request):
    return render(request, 'main_templates/order_success.html')

@login_required
def live_bidding_view(request):
    illustrations = Illustration.objects.filter(selling_type='bid').select_related('uploaded_by')

    illustration_data = [
        {
            'id': illustration.id,
            'title': illustration.title,
            'price': illustration.price,
            'image': illustration.image.url,
            'illustrator_name': illustration.uploaded_by.get_full_name(),
            'is_bidding_active': illustration.is_bidding_active,
            'bidding_end_time': illustration.bidding_end_time,
        }
        for illustration in illustrations
    ]

    return render(request, 'main_templates/live_bidding.html', {'illustrations': illustration_data})

@login_required
def illustration_bidding_view(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)
    
    # Check if bidding is active
    if not illustration.is_bidding_active:
        messages.warning(request, "Bidding is not active for this illustration.")
        return redirect('illustration_details', illustration_id=illustration_id)
    
    # Get bidding history
    bidding_history = Bid.objects.filter(illustration=illustration).order_by('-timestamp')
    
    # Get current highest bid
    current_bid = bidding_history.first()
    current_bid_amount = current_bid.amount if current_bid else illustration.price
    
    # Calculate time remaining
    time_remaining = None
    if illustration.bidding_end_time:
        time_remaining = illustration.bidding_end_time - timezone.now()
    
    context = {
        'illustration': illustration,
        'bidding_history': bidding_history,
        'time_remaining': time_remaining,
        'current_bid': current_bid_amount,
        'min_bid': current_bid_amount + 1 if current_bid_amount else illustration.price,
    }
    
    return render(request, 'main_templates/illustration_bidding.html', context)

@login_required
def bidding_history(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)
    bids = Bid.objects.filter(illustration=illustration).order_by('-timestamp')

    return render(request, 'main_templates/bidding_history.html', {
        'illustration': illustration,
        'bids': bids
    })

@login_required
def add_to_cart(request, illustration_id):
    illustration = get_object_or_404(Illustration, id=illustration_id)
    cart_item, created = CartItem.objects.get_or_create(
        user=request.user,
        illustration=illustration,
        defaults={'quantity': 1}
    )
    
    if not created:
        cart_item.quantity += 1
        cart_item.save()
    
    messages.success(request, f'Added {illustration.title} to your cart')
    
    if request.headers.get('X-Requested-With') == 'XMLHttpRequest':
        return JsonResponse({
            'success': True,
            'message': f'Added {illustration.title} to your cart'
        })
    
    return redirect('cart')


@login_required
def view_cart(request):
    cart_items = CartItem.objects.filter(user=request.user)
    total_price = sum(item.get_total_price() for item in cart_items)

    return render(request, 'main_templates/your_cart.html', {
        'cart_items': cart_items,
        'total_price': total_price
    })


@login_required
def remove_from_cart(request, cart_item_id):
    cart_item = get_object_or_404(CartItem, id=cart_item_id, user=request.user)
    cart_item.delete()
    messages.success(request, "Item removed from cart.")
    return redirect('view_cart')

@login_required
def delete_artwork(request, artwork_id):
    artwork = get_object_or_404(Illustration, id=artwork_id, uploaded_by=request.user)
    
    if request.method == 'POST':
        artwork.delete()
        messages.success(request, 'Artwork deleted successfully!')
        return redirect('my_artworks')
    
    return render(request, 'main_templates/delete_artwork.html', {
        'artwork': artwork
    })