{% extends 'main_templates/main_base.html' %}
{% load static %}

{% block title %}Live Bidding - {{ illustration.title }}{% endblock %}

{% block content %}
    <!-- Bidding Hero Section -->
    <section class="bidding-hero">
        <div class="hero-content">
        <div class="hero-text">
            <h1>Live Auction</h1>
            <p class="artwork-title">{{ illustration.title }}</p>
            <div class="artist-info">
                <img src="{{ illustration.uploaded_by.profile_image.url|default:'/static/images/default-avatar.png' }}" alt="{{ illustration.uploaded_by.get_full_name }}">
                <span>by {{ illustration.uploaded_by.get_full_name }}</span>
            </div>
        </div>
        <div class="hero-stats">
            <div class="stat-item">
                <i class="fas fa-users"></i>
                <span class="count" id="bid-count">{{ bid_count }}</span>
                <span class="label">Active Bidders</span>
            </div>
            <div class="stat-item">
                <i class="fas fa-clock"></i>
                <span id="bidding-timer" data-end-time="{{ illustration.bidding_end_time|date:'Y-m-d H:i:s' }}">Loading...</span>
            </div>
        </div>
        </div>
    </section>

    <!-- Live Bidding Section -->
    <section class="live-bidding-section">
        <div class="bidding-container">
            <div class="bidding-grid">
                <!-- Illustration Preview -->
                <div class="illustration-preview">
                    <div class="preview-image">
                        <img src="{{ illustration.image.url }}" alt="{{ illustration.title }}">
                        <div class="image-overlay">
                        <button class="zoom-btn" onclick="imageZoom.toggleZoom('{{ illustration.image.url }}')">
                                <i class="fas fa-search-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="artwork-details">
                        <div class="detail-item">
                            <i class="fas fa-palette"></i>
                            <div class="detail-content">
                                <span class="label">Category</span>
                                <span class="value">{{ illustration.category.name }}</span>
                            </div>
                        </div>
                        <div class="detail-item">
                            <i class="fas fa-tag"></i>
                            <div class="detail-content">
                                <span class="label">Starting Price</span>
                                <span class="value">${{ illustration.price }}</span>
                            </div>
                        </div>
                    <div class="detail-item">
                        <i class="fas fa-info-circle"></i>
                        <div class="detail-content">
                            <span class="label">Description</span>
                            <span class="value">{{ illustration.description|truncatewords:20 }}</span>
                        </div>
                    </div>
                    </div>
                </div>

                <!-- Bidding Information -->
                <div class="bidding-info">
                    <div class="bidding-status">
                        <div class="current-bid">
                            <div class="bid-amount">
                                <span class="label">Current Highest Bid</span>
                                <span class="amount" id="highest-bid">${{ current_bid }}</span>
                            </div>
                            {% if bidding_history.first %}
                                <div class="highest-bidder">
                                    <span class="label">Highest Bidder</span>
                                    <span class="bidder" id="highest-bidder">{{ bidding_history.first.user.get_full_name }}</span>
                                </div>
                            {% endif %}
                        </div>

                        {% if request.user.is_authenticated %}
                        <form id="bid-form" class="bid-form" method="POST" action="{% url 'place_bid' illustration.id %}">
                            {% csrf_token %}
                            <div class="bid-input-group">
                                <span class="currency">$</span>
                                <input type="number" 
                                       id="bid-amount" 
                                       name="bid_amount" 
                                       step="0.01" 
                                       min="{{ min_bid }}" 
                                       required 
                                       placeholder="Enter your bid amount"
                                       class="bid-input">
                            </div>
                            <p class="min-bid-note">Minimum bid: ${{ min_bid }}</p>
                            <div class="error-message" id="bid-error"></div>
                            <button type="submit" class="place-bid-btn" id="submit-bid-btn">
                                <i class="fas fa-gavel"></i>
                                Place Bid
                            </button>
                        </form>
                        {% else %}
                            <div class="login-prompt">
                                <i class="fas fa-lock"></i>
                                <p>Please <a href="{% url 'login' %}?next={{ request.path }}">login</a> to place a bid</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Bid History -->
                    <div class="bid-history">
                    <div class="history-header">
                        <h3>
                            <i class="fas fa-history"></i>
                            Bid History
                        </h3>
                        <div class="history-filters">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="recent">Recent</button>
                            <button class="filter-btn" data-filter="top">Top Bids</button>
                        </div>
                    </div>
                        <div class="history-list" id="bid-history">
                            {% for bid in bidding_history %}
                                <div class="history-item">
                                    <div class="bid-info">
                                    <div class="bidder-info">
                                        <img src="{{ bid.user.profile_image.url|default:'/static/images/default-avatar.png' }}" alt="{{ bid.user.get_full_name }}">
                                        <span class="bidder-name">{{ bid.user.get_full_name }}</span>
                                    </div>
                                    <span class="bid-amount">${{ bid.amount }}</span>
                                    </div>
                                    <span class="bid-time">{{ bid.timestamp|timesince }} ago</span>
                                </div>
                            {% empty %}
                                <div class="no-bids">
                                    <i class="fas fa-info-circle"></i>
                                    <p>No bids placed yet. Be the first to bid!</p>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Image Zoom Modal -->
    <div id="zoomModal" class="modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="zoomedImage">
    </div>
{% endblock %}

{% block extra_js %}
    <script>
    // Initialize WebSocket connection
    const socket = new WebSocket(
        'ws://' + window.location.host + '/ws/illustration/{{ illustration.id }}/'
    );

    // Handle WebSocket messages
    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'bid_update') {
            updateBidDisplay(data);
        }
    };

    // Update bid display
    function updateBidDisplay(data) {
        document.getElementById('highest-bid').textContent = '$' + data.bid_amount;
        document.getElementById('highest-bidder').textContent = data.bidder_name;
        
        // Update minimum bid input
        const bidInput = document.getElementById('bid-amount');
        const minBid = parseFloat(data.bid_amount) + 1;
        bidInput.min = minBid;
        bidInput.placeholder = 'Enter your bid amount (min: $' + minBid + ')';
        
        // Update bid history
        const historyList = document.getElementById('bid-history');
        const newBid = document.createElement('div');
        newBid.className = 'history-item';
        newBid.innerHTML = `
            <div class="bid-info">
                <div class="bidder-info">
                    <img src="${data.bidder_image}" alt="${data.bidder_name}">
                    <span class="bidder-name">${data.bidder_name}</span>
                </div>
                <span class="bid-amount">$${data.bid_amount}</span>
            </div>
            <span class="bid-time">Just now</span>
        `;
        historyList.insertBefore(newBid, historyList.firstChild);
    }

    // Handle bid form submission
    const bidForm = document.getElementById('bid-form');
    if (bidForm) {
        bidForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const bidAmount = parseFloat(document.getElementById('bid-amount').value);
            const minBid = parseFloat(bidForm.querySelector('input[name="bid_amount"]').min);
            
            if (bidAmount < minBid) {
                document.getElementById('bid-error').textContent = 
                    'Bid must be higher than current highest bid ($' + minBid + ')';
                document.getElementById('bid-error').style.display = 'block';
                return;
            }
            
            // Submit the form normally
            bidForm.submit();
        });
    }

    // Show notification
    function showNotification(message, type) {
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.remove();
        }, 3000);
    }

    // Initialize bidding timer
    const timerElement = document.getElementById('bidding-timer');
    if (timerElement) {
        const endTime = new Date(timerElement.dataset.endTime).getTime();
        
        function updateTimer() {
            const now = new Date().getTime();
            const distance = endTime - now;
            
            if (distance < 0) {
                timerElement.innerHTML = 'Auction Ended';
                return;
            }
            
            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerElement.innerHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
        }
        
        updateTimer();
        setInterval(updateTimer, 1000);
    }

    // Image zoom functionality
    const imageZoom = {
        modal: document.getElementById('zoomModal'),
        modalImg: document.getElementById('zoomedImage'),
        closeBtn: document.querySelector('.close-modal'),
        
        toggleZoom: function(imageUrl) {
            this.modal.style.display = 'flex';
            this.modalImg.src = imageUrl;
        },
        
        closeZoom: function() {
            this.modal.style.display = 'none';
        }
    };

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target === imageZoom.modal) {
            imageZoom.closeZoom();
        }
    };

    // Close modal with close button
    imageZoom.closeBtn.onclick = function() {
        imageZoom.closeZoom();
    };
</script>
{% endblock %}
